{
	"name": "aqsjsontocsv",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "aqs_dailydata_raw",
						"type": "DatasetReference"
					},
					"name": "aqsjson"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "utahaq_blob_output",
						"type": "LinkedServiceReference"
					},
					"name": "sinktoaqsclean"
				}
			],
			"transformations": [
				{
					"name": "flattenjson"
				}
			],
			"scriptLines": [
				"parameters{",
				"     year as string",
				"}",
				"source(output(",
				"          Data as (aqi as short, arithmetic_mean as double, cbsa as string, cbsa_code as integer, city as string, county as string, county_code as short, date_local as date, date_of_last_change as date, datum as string, event_type as string, first_max_hour as short, first_max_value as double, latitude as double, local_site_name as string, longitude as double, method as string, method_code as short, observation_count as short, observation_percent as double, parameter as string, parameter_code as integer, poc as short, pollutant_standard as string, sample_duration as string, sample_duration_code as string, site_address as string, site_number as short, state as string, state_code as short, units_of_measure as string, validity_indicator as boolean)[],",
				"          Header as (request_time as string, rows as short, status as string, url as string)[]",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine',",
				"     dateFormats: ['yyyy-MM-dd'],",
				"     timestampFormats: ['yyyy-MM-dd\\'T\\'HH:mm:ss'],",
				"     preferredIntegralType: 'integer',",
				"     preferredFractionalType: 'decimal') ~> aqsjson",
				"aqsjson foldDown(unroll(Data),",
				"     mapColumn(",
				"          date = Data.date_local,",
				"          county_id = Data.county_code,",
				"          site_id = Data.site_number,",
				"          parameter_id = Data.parameter_code,",
				"          method_id = Data.method_code,",
				"          observation_count = Data.observation_count,",
				"          pollutant_standard = Data.pollutant_standard,",
				"          pollutant_result_avg = Data.arithmetic_mean,",
				"          pollutant_result_max = Data.first_max_value,",
				"          pollutant_aqi_avg = Data.aqi,",
				"          latitude = Data.latitude,",
				"          longitude = Data.longitude,",
				"          validity_indicator = Data.validity_indicator",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flattenjson",
				"flattenjson sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'delimited',",
				"     container: 'aqsclean',",
				"     folderPath: ($year),",
				"     truncate: true,",
				"     columnDelimiter: ',',",
				"     escapeChar: '\\\\',",
				"     quoteChar: '\\\"',",
				"     columnNamesAsHeader: false,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> sinktoaqsclean"
			]
		}
	}
}